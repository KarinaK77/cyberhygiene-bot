import logging
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import Updater, CommandHandler, MessageHandler, Filters, CallbackContext, CallbackQueryHandler
from config import Config
from database import db
from scoring import scoring
from lessons import lesson_system
from phishing_simulation import phishing_sim

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)

logger = logging.getLogger(__name__)

# ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –ö–û–ú–ê–ù–î ==========

def start(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    user = update.effective_user
    
    # –î–æ–±–∞–≤–ª—è–µ–º/–æ–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ë–î
    db.add_or_update_user(
        user_id=user.id,
        username=user.username,
        first_name=user.first_name,
        last_name=user.last_name
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user_info = db.get_user(user.id)
    level_info = scoring.get_user_level_info(user.id)
    
    if user_info and level_info and user_info['total_score'] > 0:
        # –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –±—ã–ª –≤ —Å–∏—Å—Ç–µ–º–µ –∏ –∏–º–µ–µ—Ç –±–∞–ª–ª—ã
        welcome_text = f"""
–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user.first_name}!

–Ø ‚Äî {Config.BOT_NAME}, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –∫–∏–±–µ—Ä–≥–∏–≥–∏–µ–Ω–µ.

–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:
üèÖ –£—Ä–æ–≤–µ–Ω—å: {level_info['level_name']} (—É—Ä–æ–≤–µ–Ω—å {level_info['level']})
‚≠ê –ë–∞–ª–ª—ã: {user_info['total_score']}

–ß—Ç–æ —è —É–º–µ—é:
‚Ä¢ üìö –û–±—É—á–∞—Ç—å –æ—Å–Ω–æ–≤–∞–º –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (/modules)
‚Ä¢ üéØ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–∏—à–∏–Ω–≥–∞ (/simulate)
‚Ä¢ üèÜ –ü–æ–∫–∞–∑–∞—Ç—å –≤–∞—à —Ä–µ–π—Ç–∏–Ω–≥ (/rating)
‚Ä¢ üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å (/stats)

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /menu –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏!
        """
    else:
        # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ –±–∞–ª–ª–æ–≤
        welcome_text = f"""
–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.first_name}!

–Ø ‚Äî {Config.BOT_NAME}, –≤–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –∫–∏–±–µ—Ä–≥–∏–≥–∏–µ–Ω–µ.

–ù–∞—á–Ω–∏—Ç–µ —Å–≤–æ–π –ø—É—Ç—å –∫ –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏!

–ß—Ç–æ —è —É–º–µ—é:
‚Ä¢ üìö –û–±—É—á–∞—Ç—å –æ—Å–Ω–æ–≤–∞–º –∫–∏–±–µ—Ä–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ (5 –º–æ–¥—É–ª–µ–π)
‚Ä¢ üéØ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–∏—à–∏–Ω–≥–∞
‚Ä¢ üèÜ –í–µ—Å—Ç–∏ —Ä–µ–π—Ç–∏–Ω–≥ –∏ –Ω–∞—á–∏—Å–ª—è—Ç—å –±–∞–ª–ª—ã
‚Ä¢ üìä –û—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å –≤–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å

–ù–∞—á–Ω–∏—Ç–µ —Å –∫–æ–º–∞–Ω–¥—ã /study11
        """
    
    # –ò–ó–ú–ï–ù–ï–ù–ò–ï: –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –±–µ–∑ parse_mode='Markdown'
    update.message.reply_text(welcome_text)
    logger.info(f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª: {user.id} - @{user.username}")
def help_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    update.message.reply_text(
        "üìã *–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:*\n\n"
        "/start - –ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã\n"
        "/help - –≠—Ç–∞ —Å–ø—Ä–∞–≤–∫–∞\n"
        "/menu - –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é\n"
        "/modules - –£—á–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏\n"
        "/simulate - –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏—à–∏–Ω–≥–∞\n"
        "/admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∞\n\n"
        "*–£—á–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏:*\n"
        "1. –û—Å–Ω–æ–≤—ã –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏\n"
        "2. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –ø–∞—Ä–æ–ª–µ–π\n"
        "3. –†–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏–µ —Ñ–∏—à–∏–Ω–≥–∞\n"
        "4. –ú–æ–±–∏–ª—å–Ω–∞—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n"
        "5. –ó–∞—â–∏—Ç–∞ –æ—Ç –≤–∏—Ä—É—Å–æ–≤",
        parse_mode='Markdown'
    )

def menu(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /menu"""
    user = update.effective_user
    user_info = db.get_user(user.id)
    
    if user_info:
        level_info = scoring.get_user_level_info(user.id)
        menu_text = f"""
üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*

*–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:*
üèÖ –£—Ä–æ–≤–µ–Ω—å: {level_info['level_name']}
‚≠ê –ë–∞–ª–ª—ã: {user_info['total_score']}

*–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:*
üìö /modules - –£—á–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏
üéØ /simulate - –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏—à–∏–Ω–≥–∞
üìä /stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
üèÜ /rating - –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥
‚öôÔ∏è /admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
‚ùì /help - –ü–æ–º–æ—â—å

*–ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –±–∞–ª–ª—ã –∏ –ø–æ–≤—ã—à–∞–π—Ç–µ —É—Ä–æ–≤–µ–Ω—å!*
        """
    else:
        menu_text = """
üè† *–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é*

*–î–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–∞–∑–¥–µ–ª—ã:*
üìö /modules - –£—á–µ–±–Ω—ã–µ –º–æ–¥—É–ª–∏
üéØ /simulate - –¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏—à–∏–Ω–≥–∞
üìä /stats - –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
üèÜ /rating - –û–±—â–∏–π —Ä–µ–π—Ç–∏–Ω–≥
‚öôÔ∏è /admin - –ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
‚ùì /help - –ü–æ–º–æ—â—å

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã!
        """
    
    update.message.reply_text(menu_text, parse_mode='Markdown')

def modules(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /modules - —Å–ø–∏—Å–æ–∫ —É—á–µ–±–Ω—ã—Ö –º–æ–¥—É–ª–µ–π"""
    try:
        user = update.effective_user
        user_info = db.get_user(user.id)
        
        if not user_info:
            # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
            db.add_or_update_user(
                user_id=user.id,
                username=user.username,
                first_name=user.first_name,
                last_name=user.last_name
            )
        
        modules_text = "üìö –£–ß–ï–ë–ù–´–ï –ú–û–î–£–õ–ò –ü–û –ö–ò–ë–ï–†–ì–ò–ì–ò–ï–ù–ï\n\n"
        
        for module_id in range(1, 6):
            module = lesson_system.get_module_info(module_id)
            if module:
                # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                progress = db.get_user_progress(user.id, module_id)
                completed = len(progress)
                total = module['lessons']
                
                # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –º–æ–¥—É–ª—è
                if completed == 0:
                    status = "üü° –ù–µ –Ω–∞—á–∞—Ç"
                elif completed < total:
                    status = "üü¢ –í –ø—Ä–æ—Ü–µ—Å—Å–µ"
                else:
                    status = "‚úÖ –ó–∞–≤–µ—Ä—à—ë–Ω"
                
                modules_text += f"–ú–æ–¥—É–ª—å {module_id}: {module['name']}\n"
                modules_text += f"–£—Ä–æ–∫–æ–≤: {completed}/{total}\n"
                modules_text += f"–û–ø–∏—Å–∞–Ω–∏–µ: {module['description']}\n"
                modules_text += f"–°—Ç–∞—Ç—É—Å: {status}\n"
                
                if completed < total:
                    # –ù–∞—Ö–æ–¥–∏–º —Å–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫
                    for lesson_id in range(1, total + 1):
                        lesson_completed = False
                        for p in progress:
                            if p['lesson_id'] == lesson_id:
                                lesson_completed = True
                                break
                        
                        if not lesson_completed:
                            modules_text += f"–°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫: /study{module_id}{lesson_id}\n"
                            break
                else:
                    modules_text += f"–ú–æ–¥—É–ª—å –∑–∞–≤–µ—Ä—à—ë–Ω!\n"
                
                modules_text += "\n"
        
        modules_text += "\n–ö–∞–∫ –Ω–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ:\n"
        modules_text += "1. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /studyXY (–Ω–∞–ø—Ä–∏–º–µ—Ä: /study11)\n"
        modules_text += "2. –ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª —É—Ä–æ–∫–∞\n"
        modules_text += "3. –û—Ç–≤–µ—Ç—å—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å (A, B, C –∏–ª–∏ D)\n"
        modules_text += "4. –ó–∞—Ä–∞–±–∞—Ç—ã–≤–∞–π—Ç–µ –±–∞–ª–ª—ã!\n\n"
        modules_text += "–ü—Ä–∏–º–µ—Ä: /study11 - –ø–µ—Ä–≤—ã–π —É—Ä–æ–∫ –ø–µ—Ä–≤–æ–≥–æ –º–æ–¥—É–ª—è"
        
        update.message.reply_text(modules_text)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ modules: {e}")
        update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–æ–¥—É–ª–µ–π.")

def process_answer(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã —É—Ä–æ–∫–æ–≤"""
    user = update.effective_user
    user_answer = update.message.text.strip().upper()
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω—ã–π —É—Ä–æ–∫
    if 'current_lesson' not in context.user_data:
        update.message.reply_text(
            "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–∫ —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /studyXY",
            parse_mode='Markdown'
        )
        return
    
    lesson_info = context.user_data['current_lesson']
    module_id = lesson_info['module_id']
    lesson_id = lesson_info['lesson_id']
    correct_answer = lesson_info['correct_answer']
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    if user_answer == correct_answer:
        # –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç - –¥–æ–±–∞–≤–ª—è–µ–º –±–∞–ª–ª—ã –°–†–ê–ó–£
        score_added = scoring.add_score_for_test(
            user.id, 
            'correct_test_answer', 
            module_id, 
            lesson_id
        )
        
        if score_added:
            # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø—Ä–æ–≥—Ä–µ—Å—Å–µ
            user_info = db.get_user(user.id)
            level_info = scoring.get_user_level_info(user.id)
            
            response = f"""
üéâ *–ü—Ä–∞–≤–∏–ª—å–Ω–æ!* 

–í—ã –∑–∞—Ä–∞–±–æ—Ç–∞–ª–∏ +{Config.SCORING_SYSTEM['correct_test_answer']} –±–∞–ª–ª–æ–≤ –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç!

*–í–∞—à –ø—Ä–æ–≥—Ä–µ—Å—Å:*
‚≠ê –í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: {user_info['total_score']}
üèÖ –£—Ä–æ–≤–µ–Ω—å: {level_info['level_name']}
üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –¥–æ —Å–ª–µ–¥. —É—Ä–æ–≤–Ω—è: {scoring.get_progress_percentage(user.id)}%

*–û–±—ä—è—Å–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–∞:*
–í—ã –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç {correct_answer}.
–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª—É—á—à–∏–π –ø–æ–¥—Ö–æ–¥ –≤ –¥–∞–Ω–Ω–æ–π —Å–∏—Ç—É–∞—Ü–∏–∏.

*üìö –ß—Ç–æ –¥–∞–ª—å—à–µ?*
‚Ä¢ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –æ–±—É—á–µ–Ω–∏–µ: /modules
‚Ä¢ –í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞: /stats
‚Ä¢ –°–ª–µ–¥—É—é—â–∏–π —É—Ä–æ–∫: /study{module_id}{lesson_id + 1}
            """
            
            # –û—Ç–º–µ—á–∞–µ–º —É—Ä–æ–∫ –∫–∞–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–π (–µ—Å–ª–∏ –≤—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã)
            success, message = lesson_system.complete_lesson(user.id, module_id, lesson_id)
            if success:
                response += f"\n\n‚úÖ *–£—Ä–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω!* {message}"
        else:
            response = "‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –±–∞–ª–ª—ã"
        
        # –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ–± —É—Ä–æ–∫–µ
        context.user_data.pop('current_lesson', None)
        
    else:
        # –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç
        lesson = lesson_system.get_lesson_content(module_id, lesson_id)
        
        response = f"""
‚ùå *–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ*

*–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:* {correct_answer}

*üí° –û–±—ä—è—Å–Ω–µ–Ω–∏–µ:*
{lesson['hint']}

*üìö –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:*
–ü—Ä–æ—á–∏—Ç–∞–π—Ç–µ –º–∞—Ç–µ—Ä–∏–∞–ª —É—Ä–æ–∫–∞ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–µ–µ –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–≤–µ—Ç–∏—Ç—å —Å–Ω–æ–≤–∞.
–û—Ç–ø—Ä–∞–≤—å—Ç–µ –±—É–∫–≤—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (A, B, C –∏–ª–∏ D)
        """
    
    update.message.reply_text(response, parse_mode='Markdown')

def simulate_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /simulate - –∑–∞–ø—É—Å–∫ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞"""
    try:
        user = update.effective_user
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–∏–º–µ—Ä
        example = phishing_sim.get_random_example(user.id)
        
        if not example:
            update.message.reply_text("‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–∏–º–µ—Ä. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.")
            return
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—Ä–∏–º–µ—Ä –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ
        context.user_data['current_phishing_example'] = example
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        message = phishing_sim.format_example_for_display(example)
        
        # –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
        keyboard = [
            [InlineKeyboardButton("üé£ –§–∏—à–∏–Ω–≥", callback_data=f'phishing_{example["id"]}_phishing')],
            [InlineKeyboardButton("‚úÖ –õ–µ–≥–∏—Ç–∏–º–Ω–æ–µ", callback_data=f'phishing_{example["id"]}_legitimate')]
        ]
        reply_markup = InlineKeyboardMarkup(keyboard)
        
        update.message.reply_text(message, parse_mode='Markdown', reply_markup=reply_markup)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ simulate_command: {e}")
        update.message.reply_text("‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞.")

def phishing_callback(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞"""
    query = update.callback_query
    query.answer()
    
    user = query.from_user
    data = query.data.split('_')
    
    if len(data) != 3 or data[0] != 'phishing':
        query.edit_message_text("‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞")
        return
    
    example_id = int(data[1])
    user_answer = data[2]  # 'phishing' –∏–ª–∏ 'legitimate'
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—Ç–≤–µ—Ç
    is_correct, correct_answer, score_earned = phishing_sim.check_answer(
        user.id, example_id, user_answer
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ
    explanation, clues = phishing_sim.get_explanation(example_id)
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º –æ—Ç–≤–µ—Ç
    if is_correct:
        result_text = f"‚úÖ *–ü—Ä–∞–≤–∏–ª—å–Ω–æ!*\n\n"
        result_text += f"–í—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏–ª–∏, —á—Ç–æ —ç—Ç–æ {correct_answer} –ø–∏—Å—å–º–æ.\n"
        result_text += f"+{score_earned} –±–∞–ª–ª–æ–≤!\n\n"
    else:
        result_text = f"‚ùå *–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ*\n\n"
        result_text += f"–≠—Ç–æ –±—ã–ª–æ {correct_answer} –ø–∏—Å—å–º–æ.\n\n"
    
    result_text += explanation
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    stats = phishing_sim.get_user_stats(user.id)
    result_text += f"\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n"
    result_text += f"üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:*\n"
    result_text += f"–ü–æ–ø—ã—Ç–æ–∫: {stats['total_attempts']}\n"
    result_text += f"–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: {stats['correct_answers']}\n"
    result_text += f"–¢–æ—á–Ω–æ—Å—Ç—å: {stats['accuracy']}%\n\n"
    result_text += f"üéØ *–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â—ë —Ä–∞–∑:* /simulate"
    
    query.edit_message_text(result_text, parse_mode='Markdown')

def admin_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    user_id = update.effective_user.id
    
    if user_id == Config.ADMIN_ID:
        # –ü–æ–ª—É—á–∞–µ–º —Å–∏—Å—Ç–µ–º–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
        system_stats = db.get_system_stats()
        all_users = db.get_all_users()
        
        admin_text = f"""
üîß *–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞*

*–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã:*
üë• –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {system_stats.get('total_users', 0)}
‚≠ê –í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: {system_stats.get('total_scores', 0)}
üìö –ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤: {system_stats.get('completed_lessons', 0)}
üéØ –ü–æ–ø—ã—Ç–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞: {system_stats.get('phishing_attempts', 0)}

*–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:*
        """
        
        # –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏—Ö 5 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        for user in all_users[:5]:
            reg_date = user['registration_date'][:10] if user['registration_date'] else 'N/A'
            admin_text += f"\nüë§ {user['username'] or user['user_id']}"
            admin_text += f" | ‚≠ê {user['total_score']}"
            admin_text += f" | üìÖ {reg_date}"
        
        admin_text += f"\n\n*–í–∞—à ID:* `{user_id}`"
        admin_text += f"\n*–ë–æ—Ç:* {Config.BOT_NAME}"
        admin_text += f"\n*–¢–æ–∫–µ–Ω:* `{Config.TELEGRAM_TOKEN[:15]}...`"
        admin_text += f"\n\n*–ö–æ–º–∞–Ω–¥—ã –∞–¥–º–∏–Ω–∞:*"
        admin_text += f"\n/testscore - –¥–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –±–∞–ª–ª—ã"
        
        update.message.reply_text(admin_text, parse_mode='Markdown')
    else:
        update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.")

def stats_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /stats - —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"""
    user = update.effective_user
    user_info = db.get_user(user.id)
    
    if not user_info:
        update.message.reply_text(
            "–°–Ω–∞—á–∞–ª–∞ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /start –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏!",
            parse_mode='Markdown'
        )
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Ä–æ–≤–Ω–µ
    level_info = scoring.get_user_level_info(user.id)
    
    # –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ñ–∏—à–∏–Ω–≥–∞
    phishing_stats = db.get_phishing_stats(user.id)
    
    # –ü–æ–ª—É—á–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –º–æ–¥—É–ª—è–º
    progress = db.get_user_progress(user.id)
    completed_modules = 0
    for module_id in range(1, 6):
        module_progress = [p for p in progress if p['module_id'] == module_id]
        if len(module_progress) >= 4:  # –í—Å–µ 4 —É—Ä–æ–∫–∞ –ø—Ä–æ–π–¥–µ–Ω—ã
            completed_modules += 1
    
    stats_text = f"""
üìä *–í–∞—à–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞*

*–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:*
üë§ –ò–º—è: {user.first_name}
üèÖ –£—Ä–æ–≤–µ–Ω—å: {level_info['level_name']}
‚≠ê –í—Å–µ–≥–æ –±–∞–ª–ª–æ–≤: {user_info['total_score']}
üìà –ü—Ä–æ–≥—Ä–µ—Å—Å: {scoring.get_progress_percentage(user.id)}%

*–£—á–µ–±–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å:*
üìö –ü—Ä–æ–π–¥–µ–Ω–æ —É—Ä–æ–∫–æ–≤: {len(progress)}
üéØ –ó–∞–≤–µ—Ä—à–µ–Ω–æ –º–æ–¥—É–ª–µ–π: {completed_modules}/5

*–¢—Ä–µ–Ω–∏—Ä–æ–≤–∫–∞ —Ñ–∏—à–∏–Ω–≥–∞:*
üéØ –ü–æ–ø—ã—Ç–æ–∫: {phishing_stats['total_attempts']}
‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: {phishing_stats['correct_answers']}
üéØ –¢–æ—á–Ω–æ—Å—Ç—å: {phishing_stats['accuracy']}%

*–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:* {user_info['registration_date']}
*–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å:* {user_info['last_active']}

–ü—Ä–æ–¥–æ–ª–∂–∞–π—Ç–µ –≤ —Ç–æ–º –∂–µ –¥—É—Ö–µ! üí™
    """
    
    update.message.reply_text(stats_text, parse_mode='Markdown')

def rating_command(update: Update, context: CallbackContext):
    """–ö–æ–º–∞–Ω–¥–∞ /rating - —Ä–µ–π—Ç–∏–Ω–≥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"""
    # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    leaderboard = db.get_leaderboard(10)
    
    if not leaderboard:
        update.message.reply_text(
            "–†–µ–π—Ç–∏–Ω–≥ –ø–æ–∫–∞ –ø—É—Å—Ç. –ë—É–¥—å—Ç–µ –ø–µ—Ä–≤—ã–º! üèÜ",
            parse_mode='Markdown'
        )
        return
    
    rating_text = "üèÜ *–¢–æ–ø-10 –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π*\n\n"
    
    for i, user in enumerate(leaderboard, 1):
        username = user['username'] or f"User_{user['user_id']}"
        score = user['total_score']
        level = user['current_level']
        
        # –≠–º–æ–¥–∑–∏ –¥–ª—è –ø–µ—Ä–≤—ã—Ö –º–µ—Å—Ç
        if i == 1:
            medal = "ü•á"
        elif i == 2:
            medal = "ü•à"
        elif i == 3:
            medal = "ü•â"
        else:
            medal = f"{i}."
        
        level_name = Config.USER_LEVELS.get(level, {}).get('name', '–ù–æ–≤–∏—á–æ–∫')
        
        rating_text += f"{medal} *{username}*\n"
        rating_text += f"   ‚≠ê {score} –±–∞–ª–ª–æ–≤ | üèÖ {level_name}\n\n"
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    current_user = update.effective_user
    current_user_info = db.get_user(current_user.id)
    
    if current_user_info:
        # –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–æ–∏—Å–∫–∞ –ø–æ–∑–∏—Ü–∏–∏
        all_users = db.get_all_users()
        user_position = None
        
        for i, user in enumerate(all_users, 1):
            if user['user_id'] == current_user.id:
                user_position = i
                break
        
        if user_position:
            rating_text += f"\n*–í–∞—à–∞ –ø–æ–∑–∏—Ü–∏—è:* #{user_position}\n"
            rating_text += f"*–í–∞—à–∏ –±–∞–ª–ª—ã:* {current_user_info['total_score']}"
    
    update.message.reply_text(rating_text, parse_mode='Markdown')

def test_score_command(update: Update, context: CallbackContext):
    """–¢–µ—Å—Ç–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–∞–ª–ª–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞)"""
    user = update.effective_user
    
    if user.id != Config.ADMIN_ID:
        update.message.reply_text("‚õî –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –±–∞–ª–ª—ã
    db.update_user_score(user.id, 10)
    
    update.message.reply_text(
        "‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ 10 –±–∞–ª–ª–æ–≤!\n"
        "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /stats –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏.",
        parse_mode='Markdown'
    )

def quick_start(update: Update, context: CallbackContext):
    """–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –æ–±—É—á–µ–Ω–∏—è"""
    update.message.reply_text(
        "üöÄ *–ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç –æ–±—É—á–µ–Ω–∏—è*\n\n"
        "*–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥:*\n"
        "–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /studyXY –≤–º–µ—Å—Ç–æ /study_X_Y\n\n"
        "*–ü—Ä–∏–º–µ—Ä—ã:*\n"
        "‚Ä¢ /study11 - 1-–π —É—Ä–æ–∫ 1-–≥–æ –º–æ–¥—É–ª—è\n"
        "‚Ä¢ /study12 - 2-–π —É—Ä–æ–∫ 1-–≥–æ –º–æ–¥—É–ª—è\n"
        "‚Ä¢ /study21 - 1-–π —É—Ä–æ–∫ 2-–≥–æ –º–æ–¥—É–ª—è\n"
        "‚Ä¢ /study54 - 4-–π —É—Ä–æ–∫ 5-–≥–æ –º–æ–¥—É–ª—è\n\n"
        "üéØ *–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å, –≤–≤–µ–¥–∏—Ç–µ:*\n"
        "üëâ /study11\n\n"
        "*–ß—Ç–æ –±—É–¥–µ—Ç –¥–∞–ª—å—à–µ:*\n"
        "1. –í—ã –ø–æ–ª—É—á–∏—Ç–µ —É—á–µ–±–Ω—ã–π –º–∞—Ç–µ—Ä–∏–∞–ª\n"
        "2. –û—Ç–≤–µ—Ç–∏—Ç–µ –Ω–∞ –≤–æ–ø—Ä–æ—Å (A, B, C –∏–ª–∏ D)\n"
        "3. –ó–∞—Ä–∞–±–æ—Ç–∞–µ—Ç–µ –±–∞–ª–ª—ã –∑–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç\n"
        "4. –°–º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —É—Ä–æ–∫—É",
        parse_mode='Markdown'
    )

def study_lesson(update: Update, context: CallbackContext):
    """–ò–∑—É—á–µ–Ω–∏–µ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —É—Ä–æ–∫–∞ (–Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç: /study11)"""
    try:
        user = update.effective_user
        command_text = update.message.text.lower()
        
        # –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è
        if not command_text.startswith('/study'):
            update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /studyXY (–Ω–∞–ø—Ä–∏–º–µ—Ä: /study11)")
            return
        
        # –ü–∞—Ä—Å–∏–º –∫–æ–º–∞–Ω–¥—É
        try:
            numbers = command_text[6:]  # –£–±–∏—Ä–∞–µ–º '/study'
            if len(numbers) != 2:
                raise ValueError
            module_id = int(numbers[0])
            lesson_id = int(numbers[1])
        except:
            update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ: /studyXY –≥–¥–µ X-–º–æ–¥—É–ª—å(1-5), Y-—É—Ä–æ–∫(1-4)")
            return
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Ä–æ–∫
        lesson = lesson_system.get_lesson_content(module_id, lesson_id)
        if not lesson:
            update.message.reply_text(f"–£—Ä–æ–∫ {module_id}.{lesson_id} –Ω–µ –Ω–∞–π–¥–µ–Ω")
            return
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
        lesson_text = (
            f"üìö –£—Ä–æ–∫ {module_id}.{lesson_id}: {lesson['title']}\n\n"
            f"{lesson['content']}\n\n"
            f"‚ùì –í–æ–ø—Ä–æ—Å: {lesson['question']}\n\n"
            f"–í–∞—Ä–∏–∞–Ω—Ç—ã –æ—Ç–≤–µ—Ç–æ–≤:\n"
            f"{chr(10).join(lesson['options'])}\n\n"
            f"üí° –ü–æ–¥—Å–∫–∞–∑–∫–∞: {lesson['hint']}\n\n"
            f"üìù –û—Ç–ø—Ä–∞–≤—å—Ç–µ –±—É–∫–≤—É –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (A, B, C –∏–ª–∏ D)"
        )
        
        # –£–∫–æ—Ä–∞—á–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –µ—Å–ª–∏ –æ–Ω —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π
        if len(lesson_text) > 4000:
            lesson_text = lesson_text[:4000] + "\n\n...(—Ç–µ–∫—Å—Ç —Å–æ–∫—Ä–∞—â–µ–Ω)"
        
        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Ä–æ–∫–µ
        context.user_data['current_lesson'] = {
            'module_id': module_id,
            'lesson_id': lesson_id,
            'correct_answer': lesson['correct_answer']
        }
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º
        update.message.reply_text(lesson_text)
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –≤ study_lesson: {e}")
        update.message.reply_text("‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —É—Ä–æ–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

def echo(update: Update, context: CallbackContext):
    """–û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    text = update.message.text.lower()
    
    if "–ø—Ä–∏–≤–µ—Ç" in text:
        update.message.reply_text("–ü—Ä–∏–≤–µ—Ç! üëã –ò—Å–ø–æ–ª—å–∑—É–π /menu –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏")
    elif "—Å–ø–∞—Å–∏–±–æ" in text:
        update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞! üòä –£–¥–∞—á–∏ –≤ –æ–±—É—á–µ–Ω–∏–∏!")
    elif "–ø–æ–º–æ—â—å" in text:
        update.message.reply_text("–ò—Å–ø–æ–ª—å–∑—É–π /help –¥–ª—è —Å–ø—Ä–∞–≤–∫–∏")
    elif "—É—Ä–æ–∫" in text or "–æ–±—É—á–µ–Ω–∏–µ" in text or "–Ω–∞—á" in text:
        update.message.reply_text("–ß—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —É—Ä–æ–∫, –∏—Å–ø–æ–ª—å–∑—É–π /study11")
    elif "—Ñ–∏—à–∏–Ω–≥" in text or "—Å–∏–º—É–ª—è—Ü–∏—è" in text:
        update.message.reply_text("–î–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞ –∏—Å–ø–æ–ª—å–∑—É–π /simulate")
    elif text.startswith('/study'):
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –∫–æ–º–∞–Ω–¥—É –≤—Ä—É—á–Ω—É—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ /study_1_1
        if '_' in text:
            update.message.reply_text(
                "üìù *–í–Ω–∏–º–∞–Ω–∏–µ!*\n\n"
                "–§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥ –∏–∑–º–µ–Ω–∏–ª—Å—è!\n"
                "–¢–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ /studyXY –≤–º–µ—Å—Ç–æ /study_X_Y\n\n"
                "*–ü—Ä–∏–º–µ—Ä—ã:*\n"
                "‚Ä¢ /study11 –≤–º–µ—Å—Ç–æ /study_1_1\n"
                "‚Ä¢ /study23 –≤–º–µ—Å—Ç–æ /study_2_3\n"
                "‚Ä¢ /study54 –≤–º–µ—Å—Ç–æ /study_5_4\n\n"
                "üéØ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ: /study11",
                parse_mode='Markdown'
            )
        else:
            # –ü—Ä–æ–±—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –Ω–æ–≤—É—é –∫–æ–º–∞–Ω–¥—É
            study_lesson(update, context)
    else:
        update.message.reply_text(
            f"ü§ñ –Ø ‚Äî {Config.BOT_NAME}, —Ç–≤–æ–π —Ç—Ä–µ–Ω–µ—Ä –ø–æ –∫–∏–±–µ—Ä–≥–∏–≥–∏–µ–Ω–µ.\n\n"
            f"*–ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥ —É—Ä–æ–∫–æ–≤:*\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /studyXY (–Ω–∞–ø—Ä–∏–º–µ—Ä: /study11)\n\n"
            f"*–ß—Ç–æ —è –ø–æ–º–æ–≥—É —Å–¥–µ–ª–∞—Ç—å:*\n"
            f"‚Ä¢ –ù–∞—á–∞—Ç—å –æ–±—É—á–µ–Ω–∏–µ (/study11)\n"
            f"‚Ä¢ –ò–∑—É—á–∞—Ç—å –º–æ–¥—É–ª–∏ (/modules)\n"
            f"‚Ä¢ –¢—Ä–µ–Ω–∏—Ä–æ–≤–∞—Ç—å —Ñ–∏—à–∏–Ω–≥ (/simulate)\n"
            f"‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å (/stats)\n"
            f"‚Ä¢ –£–≤–∏–¥–µ—Ç—å —Ä–µ–π—Ç–∏–Ω–≥ (/rating)\n\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π /menu –¥–ª—è –≤—ã–±–æ—Ä–∞ —Ä–∞–∑–¥–µ–ª–∞!",
            parse_mode='Markdown'
        )

# ========== –ó–ê–ü–£–°–ö –ë–û–¢–ê ==========

def main():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è"""
    print("=" * 60)
    print("üöÄ –ó–ê–ü–£–°–ö –ë–û–¢–ê –î–õ–Ø –ö–£–†–°–û–í–û–ô")
    print("=" * 60)
    print(f"ü§ñ –ë–æ—Ç: {Config.BOT_NAME}")
    print(f"üìä –£—Ä–æ–≤–Ω–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {len(Config.USER_LEVELS)}")
    print(f"üîë –¢–æ–∫–µ–Ω: {Config.TELEGRAM_TOKEN[:15]}...")
    print("=" * 60)
    
    try:
        # –°–æ–∑–¥–∞—ë–º Updater —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
        print("üîÑ –°–æ–∑–¥–∞—é Updater...")
        
        # –í–∞—Ä–∏–∞–Ω—Ç 1: –ü—Ä–æ—Å—Ç–æ–π —Å–ø–æ—Å–æ–± —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
        updater = Updater(
            token=Config.TELEGRAM_TOKEN, 
            use_context=True,
            request_kwargs={'read_timeout': 30, 'connect_timeout': 30}
        )
        
        dispatcher = updater.dispatcher
        print("‚úÖ Updater —Å–æ–∑–¥–∞–Ω")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
        basic_commands = [
            ("start", start),
            ("help", help_command),
            ("menu", menu),
            ("modules", modules),
            ("simulate", simulate_command),
            ("stats", stats_command),
            ("rating", rating_command),
            ("testscore", test_score_command),
            ("admin", admin_command),
            ("quickstart", quick_start),
        ]
        
        for cmd_name, cmd_func in basic_commands:
            dispatcher.add_handler(CommandHandler(cmd_name, cmd_func))
            print(f"‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∞ –∫–æ–º–∞–Ω–¥–∞: /{cmd_name}")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –∫–æ–º–∞–Ω–¥—ã —É—Ä–æ–∫–æ–≤
        print("\nüìö –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É—é –∫–æ–º–∞–Ω–¥—ã —É—Ä–æ–∫–æ–≤...")
        lesson_count = 0
        
        for module_id in range(1, 6):  # 5 –º–æ–¥—É–ª–µ–π
            for lesson_id in range(1, 5):  # 4 —É—Ä–æ–∫–∞ –≤ –∫–∞–∂–¥–æ–º –º–æ–¥—É–ª–µ
                command_name = f"study{module_id}{lesson_id}"
                dispatcher.add_handler(CommandHandler(command_name, study_lesson))
                lesson_count += 1
        
        print(f"‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–æ {lesson_count} –∫–æ–º–∞–Ω–¥ —É—Ä–æ–∫–æ–≤")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞
        dispatcher.add_handler(CallbackQueryHandler(phishing_callback, pattern='^phishing_'))
        print("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ —Ñ–∏—à–∏–Ω–≥–∞")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤ (–±—É–∫–≤—ã A, B, C, D)
        dispatcher.add_handler(MessageHandler(
            Filters.regex('^[A-Da-d]$'),
            process_answer
        ))
        print("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–æ–≤")
        
        # –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–±—ã—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
        dispatcher.add_handler(MessageHandler(Filters.text & ~Filters.command, echo))
        print("‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–æ–±—â–µ–Ω–∏–π")
        
        # –ó–∞–ø—É—Å–∫–∞–µ–º –±–æ—Ç–∞
        print("\n" + "=" * 60)
        print("ü§ñ –ë–û–¢ –ó–ê–ü–£–©–ï–ù –ò –ì–û–¢–û–í –ö –†–ê–ë–û–¢–ï!")
        print("=" * 60)
        print("üì± *–§–æ—Ä–º–∞—Ç –∫–æ–º–∞–Ω–¥ —É—Ä–æ–∫–æ–≤:*")
        print("   –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ /studyXY –≥–¥–µ X-–º–æ–¥—É–ª—å(1-5), Y-—É—Ä–æ–∫(1-4)")
        print("   –ù–∞–ø—Ä–∏–º–µ—Ä: /study11, /study23, /study54")
        print("=" * 60)
        print("üìã *–ß—Ç–æ –¥–µ–ª–∞—Ç—å –≤ Telegram:*")
        print("1. –ù–∞–ø–∏—à–∏—Ç–µ /start - –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã")
        print("2. –ù–∞–ø–∏—à–∏—Ç–µ /study11 - –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ —É—Ä–æ–∫–∞")
        print("3. –ù–∞–ø–∏—à–∏—Ç–µ /simulate - –¥–ª—è —Ç—Ä–µ–Ω–∏—Ä–æ–≤–∫–∏ —Ñ–∏—à–∏–Ω–≥–∞")
        print("4. –ù–∞–ø–∏—à–∏—Ç–µ /modules - –¥–ª—è —Å–ø–∏—Å–∫–∞ –º–æ–¥—É–ª–µ–π")
        print("=" * 60)
        print("‚èπÔ∏è –ù–∞–∂–º–∏—Ç–µ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –±–æ—Ç–∞")
        print("=" * 60)
        
        updater.start_polling()
        print("‚úÖ –ë–æ—Ç –∑–∞–ø—É—â–µ–Ω –∏ —Å–ª—É—à–∞–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...")
        updater.idle()
        
    except Exception as e:
        print(f"\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê –ü–†–ò –ó–ê–ü–£–°–ö–ï –ë–û–¢–ê: {e}")
        print("=" * 60)
        import traceback
        traceback.print_exc()
        print("=" * 60)
        input("–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –≤—ã—Ö–æ–¥–∞...")

if __name__ == '__main__':
    main()